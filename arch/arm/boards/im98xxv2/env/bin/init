#!/bin/sh

PATH=/env/bin
export PATH

. /env/config

auto_trim

#if [ -e /dev/icon0 ]; then
	cp /dev/icon0 /dev/ram3
#fi

battery_charging

if [ -e /dev/factory0 ]; then
	echo "Copy IMEI/SN from NAND to SDRAM"
	cp /dev/factory0 /dev/ram2
else
	echo "Could not find /dev/factory0"
fi

if [ -e /env/bin/download_boot ]; then
	echo "Enter download mode:"
        if [ -e /dev/ramloader0 ]; then
                cp /dev/ramloader0 /dev/ram1
                go 0x1FFE0000
        else
                echo "Can not find ramloader"
        fi
else
	echo "Enter normal mode:"
	echo "Download ARM7 Vector SDRAM"
	a7_vector_sdram

	echo "Open Dual SIM LDO Voltage as 3.3(V)"
	sim_open 3

	if [ -e /dev/nand0 ]; then
		addpart /dev/nand0 $nand_parts

		echo "Download ARM7 image from NAND to SDRAM"
		# PS Modem size is less than 4M
		memcpps -l -s /dev/nand0.modem -d /dev/mem 0x0 0x40000000 6M
	fi

	if [ -e /dev/phy0 ]; then
		eth0.ipaddr=$ipaddr
		eth0.netmask=$netmask
		eth0.gateway=$gateway
		eth0.serverip=$serverip
		if [ -z $eth0.ipaddr ]; then
			while [ -z $eth0.ipaddr ]; do
				readline "No IP Address for eth0. Please enter IP Address:" eth0.ipaddr
			done
			echo -a /env/config "ipaddr=$eth0.ipaddr"
			env_status=1
		fi

		if [ -z $eth0.netmask ]; then
			while [ -z $eth0.netmask ]; do
				readline "No Netmask for eth0. Please enter Netmask: " eth0.netmask
			done
			echo -a /env/config "netmask=$eth0.netmask"
			env_status=1
		fi

		if [ -z $eth0.gateway ]; then
			while [ -z $eth0.gateway ]; do
				readline "No Gateway Address for eth0. Please enter Gateway Address: " eth0.gateway
			done
			echo -a /env/config "gateway=$eth0.gateway"
			env_status=1
		fi

		if [ -z $eth0.serverip ]; then
			while [ -z $eth0.serverip ]; do
				readline "No Server IP Address for eth0. Please enter Server IP Address: " eth0.serverip
			done
			echo -a /env/config "serverip=$eth0.serverip"
			env_status=1
		fi

		if [ x$env_status = x1 ]; then
			while [ -z $save_environment ]; do
				readline "Save Environment Parameters. yes/no: " save_environment
			done
			if [ x$save_environment = xyes ]; then
				save
			fi
		fi
	fi

	echo -n "Hit any key to stop autoboot: "
	timeout -a $autoboot_timeout

	if [ $? != 0 ]; then
		echo
		echo "type 'boot net [<imagename>]' to load Android Boot Image from Ethernet"
		echo "type 'boot nand' to load Android Boot Image from NAND Flash"
		echo "type 'usb_download net <imagename>' to load ramloader for USB Downloader"
		echo "type 'usb_download nand' to load ramloader for USB Downloader"
		echo
		exit
	fi

	echo "Boot up Android Boot Image"
	boot nand

fi
